@using DeRosaWebApp.Repository.Interfaces;
@using DeRosaWebApp.ViewModel;
@using System.Globalization;
@model MeusPedidosViewModel
@{
    var DateTimes = new List<DateTime>();
    var dateTimeNull = new DateTime(1, 1, 1); ;
}
@try
{
    @if (Model.Pedidos.Count() == 0)
    {
        <h1 class="text-center">Você ainda não realizou nenhum pedido</h1>
    }
    <div class="container">
        <div class="row">
            @foreach (var pedido in Model.Pedidos)
            {
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body" style="background-color: gray">
                            <h5 class="card-title">Pedido: @pedido.Cod_Pedido</h5>
                            <p class="card-text">Data do Pedido: @pedido.DataPedido</p>
                            <p class="card-text">Endereço: @pedido.Logradouro @pedido.Numero</p>
                            <p class="card-text">Nome: @pedido.Nome</p>
                            <p class="card-text">Preço total: R$@pedido.TotalPedido.ToString("F2",@CultureInfo.InvariantCulture)</p>
                            <p class="card-text">Total itens pedido: @pedido.TotalItensPedido</p>
                            @if(!pedido.DataParaEntregar.Equals(dateTimeNull))
                            {
                                <p class="card-text" style="color: yellow">Data aproximada da entrega de comemorativos: @pedido.DataParaEntregar.ToString("dd/MM/yyyy")</p>
                            }
                            @if (pedido.Pago)
                            {
                                <p>
                                    <strong>Status:  </strong>
                                    @if (pedido.Concluido)
                                    {
                                        <span> Seu pedido já foi preparado! </span>
                                    }
                                    else
                                    {
                                        <span> Seu pedido já foi recebido!</span>
                                    }

                                    @if (pedido.Entregue)
                                    {
                                        <span> O Seu pedido já foi entregue :)</span>
                                    }
                                    else if (pedido.Concluido)
                                    {
                                        <span>Seu pedido já foi preparado e irá ser entregue em breve!</span>
                                    }
                                    else
                                    {
                                        <span>Mas ainda não saiu para a entrega.</span>
                                    }

                                </p>

                            }
                            else
                            {

                                <a asp-action="Resumo" asp-controller="Pedido" asp-route-cod_pedido="@pedido.Cod_Pedido"><p>Finalize o pagamento até @pedido.DataExpiracao.ToString("dd/MM/yyyy HH:mm:ss")</p></a>
                                DateTimes.Add(pedido.DataExpiracao);
                            }

                            <h6>Produtos:</h6>
                            @inject IPedidoService _pedidoService
                            @{
                                var produtosInPedidos = await _pedidoService.GetMeusProdutos(pedido.Cod_Pedido);

                                foreach (var produto in produtosInPedidos)
                                {

                                    <div class="media">
                                        @if (produto.ImagemUrl.Contains("www") || produto.ImagemUrl.Contains("https") || produto.ImagemUrl.Contains("http"))
                                        {
                                            <img src='@produto.ImagemUrl' class="mr-3" alt="Imagem do Produto" style="max-width: 100px;">
                                        }
                                        else
                                        {
                                            <img src="@produto.ImagemUrl" class="mr-3" alt="Imagem do Produto" style="max-width: 100px;">
                                        }

                                        <div class="media-body">
                                            <h5 class="mt-0">@produto.Nome</h5>
                                            <p>@produto.DescricaoCurta</p>
                                            <p>Preço do produto R$@produto.Preco.ToString("F2",@CultureInfo.InvariantCulture)</p>
                                        </div>
                                    </div>
                                }
                                @foreach (PedidoDetalhe p in pedido._PedidoDetalhes)
                                {
                                    if (p.Quantidade > 1)
                                    {
                                        <p style="color: yellow; font-size: smaller">Informações adicionais:   @p.Produto.Nome <strong>foi adicionado x @p.Quantidade vezes</strong></p>

                                    }
                                    else
                                    {
                                        <p style="color: yellow; font-size: smaller">Informações adicionais:   @p.Produto.Nome <strong>foi adicionado x @p.Quantidade vez</strong></p>

                                    }
                                }

                            }
                            @{
                                var telefone = "5531999999999";
                                var pedidoUrl = "https://wa.me/" + telefone + "?text=Ol%C3%A1%21%20Estou%20entrando%20em%20contato%20sobre%20o%20pedido%20Nº%20" + pedido.Cod_Pedido + "%2C%20feito%20em%20" + pedido.DataPedido.ToString("dd/MM/yyyy") + ".%20Seria%20poss%C3%ADvel%20discutir%20alguns%20detalhes%3F";
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}
catch (NullReferenceException)
{
    <h2>Carregando... por favor, recarregue a página</h2>
    <script>
        window.location.reload();
    </script>
}



<script>
    function checkOrders() {
        const currentDate = new Date();
        const ordersDate = @Json.Serialize(DateTimes);

        for (const orderExpireDate of ordersDate) {
            const expireDate = new Date(orderExpireDate);

            if (expireDate < currentDate) {
                @inject IPedidoService _pedidoService
    @{
        await _pedidoService.VerificarPedidosExpirados();
    }
                    window.location.reload();
            }
        }

    }

    checkOrders();

    setInterval(checkOrders, 30000);

</script>